# 【emmmbedding】不用存储的图床！

大家平时会用到图床服务吗？

部署图床服务需要很大的存储空间，而且云服务卖的硬盘通常是按容量×时间算钱的，所以做一个图床实际上要随时间花费O(n**2)的钱。

那有没有什么既能永久存储图片，又不用花钱的办法呢？

正好聪明的莉沫酱发明了不用存储的图床，有了它就不需要硬盘啦！


## 原理

其实是用了stable-diffusion的vae，用户上传了图片之后，就把图片压缩一个很小的矩阵，用base64整个塞到url里，然后有人访问这个url的时候，再从url里还原出图片！

举个例子——

输入1张 316×316 的图片: 

![Lenna.jpg](example/Lenna.jpg)

经过vae编码之后，得到这个tensor，尺寸是`[1, 4, 39, 39]`: 

```python
tensor([[[[ 1.0445e+01,  8.4394e+00,  6.9553e+00,  ...,  5.4966e+00,
            5.2353e+00,  8.0868e+00],
          [ 9.9430e+00,  6.4219e+00,  8.6987e+00,  ...,  6.0790e+00,
            8.8426e+00, -7.1120e-01],
          [ 8.4888e+00,  1.0169e+01,  1.0712e+01,  ...,  1.0351e+01,
            7.3863e-01,  2.0532e+00],
          ...,
```

然后把tensor经过uint8量化、lzma压缩、base64，就可以得到一个url: 

```
http://localhost:8000/image?q=XQAAAAT__________wAYP8SMEmSEQmNOfoVPXLrqyAxBrVE7mcuJHVfQQME_mjOGTMe89SusEQaATYofYczKkBHUtYuqch-MCtpjSJJlm-i3czMlj1wWlMOt347pZOD9swwYmKyQTO1RMAJvngCjNba4SEY6DxSd7K6H0rv0NPn6BfGt3EerDJKKw86TeuIIkQWfQpw77brCIvU48fwGYJyEf-duiMgjmqIvt9vzFcqk0sZm-bdJJ11WFdVyE3cKda9yqA_20vf7fjvT3cdEXNt9Spj9bRX54kN0Gibes_0JykTX2zEdgQilDEBgJVpogqN0f0Di0aUP3GrsVtoXGdOAhDYgIFagsOZid3B7S719Q1cze6IrsRRhzkHDLXhzGfhB2y4qL7iFOuL6mTpBA_YUTI8VkU-fkLL1EuG-MnIck0IwgTQG7pMnQdphZf04ZML0P_GpmkF5GQFDcrxohD2Z_9g_f5yghq8W3zfhNGqVYeb_HUH4nx1cxMpIVxBo7z9HMhumodva899F8wzQy_6hDPOZJKOcobKsoRdbf0PZ2Yrm819aqL4SjPrs0V8vEJhcL7Hi9WwdkjkNBF3TY7lUhY4oNXVK_0BpxDftnUUsNdDPd8MUdQtJTmkVdoIpaN6k9MUblWc5-MeFGwZfu0eum0m5HbnXpe6bPMxnBXuqiNpcx-LZK9q3DLXwm3TSTqppqM93Iy-JO83iqHUtQPpegdIFVhnaDq9r3k1zNCJ8U4b7CJBfLc5cxwiCfSL8p2wjzMsOTYVcJBhyEa9_Ridla514KagEoTP5LcFg8ZBVxcktNoY4c0JcIUi9LZiqQ8Hh539pWnxA_CuT_eTfeEH8irz_b32pNXxTFqquPdX9LCqHSgv07K8_wpS9LDLPViuD5DcVuUATtpFBW9YHdOvZCULBWXhvH-YKg2ztdq3WtmNzpsUkr8zU-hCOTh6lf5qkHbclmMYe3Zn5xf6bF4napNh6mUC8Y-qgUIJgDq0mSbU2dh_JKNNbWod4dmyAIQ_qHQqBeDHYVKoXEYGl7oNpHKoNDnZ7jFlunL7km3Imu2XD1r3t15HJOJ_w-wtasZXcqkN0kH04OCKaFdXiGy-VKQV37E_3Kdrn8c-Ec2F8teLwJSuwvKx6t7L6nh3y42mi7H9fS9c2e7zf6k-pikAQaEfbm8UVCCgj7fSh4iiY8DmhqZWegzl6J0l-GJa3enwv9u2yj9SF7FY-8o7n9hWEYRPDhQru9dypBWbPQJe3NWHD7wSuRKqeFk6_GnkEKMUazuV5unMqnxgM-aB2gcnMHTp5fUVwBxBV6X9KVETFXRz5j2FhtmQnFY1wJ8k9EDcW8pxEQpwRxWcfk-4M9mHjG6gQCl9Lh02Fvb2sGqcoYp75FX7e8BplXnWfakTvIM9kK42aiurI6M3LmApiSFWQmhPXi6iWAX67IqINSL9rKy0k6hC9TtxyiGgi5xM5BLZWfwXBjntUtpj5aPizDKSGVSn1pVRIgTHY6b7x_BDa9Kc_ck4h-Gktl_HnOrjnnEVa4XwVMHoBOVP7vGDLnxi3aGpUhrklkU7kp1Drjm7vZ_fjytZrewsWzdPrwaLMOZfDgDHvPlIannrI2y-CCKqQ4PwIvLydrVnEoGEudhTMzvGEzlK8iK5dkI1sgFr8UojO01HCazD8YgTZrevkHV2U9eGNpHPZ8X6NYXnQlkSztYZT_x5qAUdC3kwSPG_O2HVY90jfvbt8ktaY-e_y6xZ8IvU4pvkXmAacxZ2m-YNhL-kAh0AnKUzi4GfrMmGi3JKBfaPKN97tsm4K_9Ulo0vhz8k_MI8UulwHzGRKwEuC7gO4Xl4y9EP-lEWMUYhLt5mIFuEACU42YUpfTybhJeEB48YE_i9olC6MM8BJOIA7sMZWWL-SdqdX-qrGYOdDj-45fmyMU4VXegWUt5CaZEE_iBnrbZFkGP3NjFPDvW7hA1RSQDSpk1XTYCI4awWJ2rTo-cGg1Klooy6sQRMjoUbF2g1udARXrKx3P3HV7u-SS8nMMHOlL9NnH7fCR627SPNz5nrVoWZM2Tpt43RXLoTnOC2KhB8r__GfbbncnAz_RfhTBUrtOT6qPG5oIghWS_HhqhcqvLM2k_wDR50GHaEljcI0zYo4tolqIZY8cB4WT3b2uCbHagDXrqComIIQ4muGtUuZBxlGyItj7YGxmwqkXFoh9io79VAReVXIcdsRCLKZoCNrCUh9kfBCDX5MJhCiExxxHHJGOcWgZRwXtEWPGIdEiqfbyw-7OaKGBEdd4RL10uLgmMvOxcT-b1rEPcLfFM4g4f45dXeJrSuK3CsBdPsTS-Fi3DTVx4aNl6GOAj7LI7MhrTNuLyd2FpXQwI6WqGgwNVCTeYpYp39y-OyOg4GlQDEkLJLu9JGB79Y3FZt7gs6OcgWg14SELqlDmQccJjyodbtf5wcSOL3trmr7vzU9aGqZOD7M1b7XXVTNpm3IJwEqjS4dxlLP8hIPwOkaGJHdj6rL0Ta58Mp-bg9qhmwTNKcghbvT-h1L-iUKRk9lVu-y77oC6eVZLwElr1LywsnbKuhzK08rDd8c5wE02N5ptof9_s_DqG0AXwS4j6fBRBxvraA_P5uNddAPRGcgFsk-htjRHiFFRFwcDcs5Xce2xQdYdYc4HvW_54W0sEDn6BQa-cip5r98v35s5f2o8McSnz12m247Pu_dRPuFUeuCODvVSBe8xWDAmM-dc6LulI-E_2seqRwyHub1C2uSh3DwW5TLRDZGnmTLU-8HMkEVI2ZyeRG0-OlogFdpCMsh0msK3VfO_8pL1iXEb6LLu0wMPf6YZWlMasBV3fuDC5j_GiP2NalvVFLZ2d-1fVZw7eO6PMMb6I_OGFWkg_jpCeLsRrH6qzO8tdWI5z6KkfO3bJ-YcID1ZHSZxnX3IuGH74HOh9XjF9ettSuuZ012-zxeEqgQsTwFS7f2RDMsWO8YQZKwtFnmDTFyY0siZEUc8hJi9Lllx8JOqJu0Rl3qYpBr6PYR7kvgC-Vxy0UxfmC9LKBssX11ds5W2FUEOkjzU1dwqcd05YLXMIpScfNuusn8HQgUnCzN2mM8vr9sdzGCOIeJbG1JYLMNiuCsYRisMWsgETaJYDCXW-fWyTGmMk_yXDz4HyYIyCxHPSDvIDS3SqWfiGVYvlPkLJ4dVWPsWwhTPDW_QPj3SvliP6CRsivag2nL_mHYvJVjPoaf2t4RwbZgns-aRULmpxqTK7Lvx0-kEo9CZxNP9DXxBl_mBsk2-V4nJJX6sTjW7zr0OKtgbQXQNAPU96bAeaVpLKsBSg03HJHPLElcVtcVpw4hbXtBwvcpXPXBeo5Bb4LYVH2DHlv7ucW0y2qzAwDY4WYkSrHVPfmfJE751Q_ZAr9aSH13ME3lz2ZnQOby5RD0fFDBEC_VVkHTH7b2H94l0-PYjsI2gJcPfm5iT6bnKlpTM764BW3S2b3ScxilRIvxQsLa8Xs_0K8OAm25YSQXCPONehaj92_iPJJwcsvrn_sI5mfQtwxaEl5S0QlSzP8yqJbzXluMs8U0KYGTRx6sXW6S7TzqkHM2-dCrxHAWxW_A-KlgGKP3hoxdi3RuYu0s3uWgWLF4riVDO5i4xO4OPTHBiTkQd8HueiyxIUiSEoAWPlYbt4f7CA3LSfS5X108NMWocOPnAeqNHi9rsrUNLO3TmOJ27jiiXGi87BpRyM1wzjQbTNzu9fvTCINhlr2jEj4ex450WELJZLqqp3NaZwJEJHnZthAECH_PT_84Stzd1CwtiNkFmp9_g47QKiu4JYRCABILqxcMOKS9F_PLHFjfr8b8kqqCErV5J0ZcPMhh4gq3hRYICDsGIhMrxmDKI88JY-Ywjc1zjsE6ruUOKefzSaWbUKBQWOWgzvLJIzbSJile11bw_pk9Px1TSLZ0xwbSEvwBB67uWLdji77J112Q_pg54gb9DLtnY4eVHtptHm_YGEL8SFsm126Jgbp_DI6f1M2IT-hRqzOvrtvg5zO8FjBE7RxMlmlQsrbYEfXIR6wFsXojJXHnERfDm7bJeuqqPzgQYCn246XKIwt7YlM8aSpRAR_oPCDl24a3WJjElPz2xtvN94FD0Y2Gq2wG29t_XTzeyjJ5oIYt1l1jS21BKUNFYpdvx30DACnswX-g5UkQU1EjUcjnui8DTstFGGqYzPAjgeDI_rP8msmpuLreZ9b0TU68h_digAslnEbn1nB5Z7GIwsOQ0DDIrxJhA5OJffkb0FgI3deCWJFfAB13gbxk5FvFUjAVN-MyEVQgQ_0d5WxAgN2RLIzUutrdjEd_N4yYLraV2LGdRGx5uDcx3BsWTDivLIPZ4YnAKNfWY37GniqC0Xm0Fo2NOyiyluTm7fvaIi9W_8cSWN3XzE1lAGyrRlnsM_7W_vdGgchYe3ZPTfBWV7G8gQu8Utb7Qxpcqy3VISa8dmqNhx2lRrKCJ3ZTKqLa0bpUtCunPH6R12UJPRGIxs3h-QFo_WRO_aLwmbcRkmB2lgGq4W3vhna9FH0iXmjVnLwcTyCkw7XIXZrW-5o2tU8DR0n_wEOUknJepGvbjWXDAUIWrBBB_RXVtJaBtPHKEz3dtBG91uMBcft7ukUQP8Y5BRmHNuSvpirLtU9P_vJ2Ai8FEB8fQ8wNlK7dH35fXVz4gDHGv1kM8zWPkDlwZwPT82in4EZbGDlGXQaGIw9SMW7F7EfOiNEm1NfNJx9bHEXw1ts8au6viEfMhR6cR-W2RHCXv6l8D1J78YmhAfhiM-xe-2MTRJeAQDyW-JGLCuAE_x4FrvmHrLrwr0NUtkqCagTyVyD0zvteW7xyG0urBD0kwELc7bM7TOFMkYHekOr1svek1jHjaeBph5VLqj67WPTKofg-vfb774jNQvAbCeH0jEbqtf_NLAKwhd83sUsfWH0Bmplu6rO2EcQcoht__NbCDpjMpCHTTwtH89n9r5-BhndpnbU9I_dXfM6J7ZiBFzL2su5UkB5a0UfowQWE9h6e6Zq5X9F8gHLEvt2WX6aAQ4JgJusqVZYFSAqaArjxdBzxWWsjITO7jH4x5geEuYCneA6G3RphOMTKwVfb4UdMUVr2jYJCsNB5nCoKziyViRZOIvLqTwKTmybiCzIONKc2-lbVjIuWFfgWwoWK1KAEsJ6e554bv0SQNLTFnbV8_d1lfg7ROrXbgRwDOumX0sHTJC_I-E7FLnbZlH-3pKo6B5IVwib5-mdmutTQObWFW7EFQpoNpMVugk7DPOluzUeGILEkVug6tMacDHyCC3pOmebmUR08X-6FKF4z1D-N_Hw_Gm6Lm2LDykMKSD6s6b8tLEoJTUhhSnZpRTGBvSnESS-OJQw8bnbzPNyuBmC5VrrqZnq5viT0LuC1ZApTrg2M9as9RZOLOhBUZoXzN5wTbVxtyWh9_wNf65MyPyCXMvbLJOvAGmWwF7a8X9LrkHblKu_uLP2XmGc8Q-XgckB7JKFw6iuDfuhn2pS40eeV2LP7MM3cZ8Fa2WiW-59nGsihX9A7xtUxDT8m-39c-O-FKj42j0ZMNNTFt0p1TpdHXhAtvZK72ObOovFTWoOA9aYxByl7tmFUkcn4l6juIp3WBQ5djLUqQi_20wGLJZWLg6Utrq1FswsUczF6fiS9S8RW5xxJnVgX8ltmInbtFb08VPP5GN6jgKAQEFewyo5jYRIHumuAzBCWMASRoLLPGLdD6pZ-foRbIMAS_WMSsYnqxVrvEZr1XWlVHiDrffEC_ts9_ca5iKZQoU0APoQtOneOMClKdR02ZSiwcZ0b4kPAGMIbKjK6KOA0dQD4XcGWa7qLQFEqGmOz2aVJP853b3wlVhCQKbEkGX9PuusGuDwWZYfPnsbIXp__RWG__4cB1ZBunY5xKHpFyoSk2uoeBCTy12iYckv24krDhVYnOUi-MbzaDwubJ5A1slWsJUv9P0cLK1z7vfSY-JiYJwvXlw1eoUEZXOVQCV0LFHAX3iqBUi0YJkmcwU9UPPVrtez4GVbaoqqqVfKaMgHlIfVLMRKCgox4D2aV6DS1k0Diht555VnKG_P62N88gQn4ujfjfh43FA55hdmLhBOH9ePW09j5rugGhtkY-FkUqSk6ag6p6CcrasVAIeQd40mhsPUmQLzhRUK0FHXn0uBOnA6vqLUQ_OTgDkHQXtxjytCkbm0mxlRGd66phIWWFpFg6SvrE4XDJOsgqcivCiDEsaHxwmozPZI1J3jEoWE4ymiMQRosyVPecBCn-XqVzT5Sh_5kKJaqPRdzhxE_s6yeJfS4qTeRAcSABsg4sYRzAC3TUrYhMlIh-EvUou5jsQy-fNQbRHvARhK_GZnswl7HWEkv0OIkAYnMVdTDSO0aiNrsOpaj4CwvZTNsuPuT6TkH1J8Q_IPZvQkKJ_xlO7fWqdFhoPeHkp8xVuVld37im-Q2zxVA2fG-kcY_yzy8htlVAz63Wjj6u2HgZ5svAzSn8Xf2Ha_kkLrt3tt5-_9WL-buwfMA0WbH802b01Wyprcg0Y4NRM3RagwwASj08HKrx39EiXFlKAmZ63iMc5U4-PNFR496QB9uMMJGEPuFlpU6ffam_XCBaTLWE_P0PXCSvBo7IRps9lG0mtZxR3PkKj8EBdNp0S45Y3ySs00rWXdGrpEjMEy-9L-pdviSXv7-fQOSd17roEd_W5ZMHQINtfxIvLN8r1lBHFLyBZuHjwQYnUOqlRl7DeEhZNkdnxznwJGo1LOwtRlMxUQjLYMYJlZ2W5FXGJjogdznesa7nqdR2zm2PReCPe6Fyi--0gvfXfrYhIGXqbxVSK7cgBNQhi5OOo01WzI1OSZt3vnTJE1iB1gMxMm6AK_qRKIrk1_1ABbr3-NMVhROrJwKSkliWbZzf-_hx7NmOontNwoo7zxH2hrFrwhn4l69G0B0W9JLSzm5LJbLT8laPWzyw4jiQRK4F-abaHdNLs8BJeXyXBq0QDDRDe99jY0kqs7OqF9JFx1jrRAMHiZnsRIrH56ADgWptyxL_v__43ggAA%3D%3D
```

访问url时，就对上面的操作分别做一次逆操作，然后再送入vae解码，就能还原出这张图片: 

![Lenna_out.webp](example/Lenna_out.webp)

看起来有一点微小的差别，不过大部分是一样的啦！


## 使用方法

首先你需要一个Python3，安装依赖:

```sh
pip install -r requirements.txt
```

启动服务: 

```sh
uvicorn main:app --host 0.0.0.0 --reload
```

然后就可以去`http://localhost:8000/`上传图片啦！


## 注意

emmmbedding看起来很像embedding，但它其实不是，它是恶魔妹妹床上用品！


## 结束

就这样，大家88，我要回去和`emmm`亲热了！
