# 【emmmbedding】不用存储的图床！

大家平时会用到图床服务吗？

部署图床服务需要很大的存储空间，而且云服务卖的硬盘通常是按容量×时间算钱的，所以做一个图床实际上要随时间花费O(n**2)的钱！

好在聪明的莉沫酱发明了不用存储的图床，这样就不需要硬盘啦！


## 原理

其实是用了stable-diffusion的vae，用户上传了图片之后，就把图片压缩一个很小的矩阵，用base64整个塞到url里，然后有人访问这个url的时候，再从url里还原出图片！

举个例子——

输入1张 316×316 的图片: 

![Lenna.jpg](example/Lenna.jpg)

经过vae编码之后，得到这个tensor，尺寸是`[1, 4, 39, 39]`: 

```python
tensor([[[[ 1.0445e+01,  8.4394e+00,  6.9553e+00,  ...,  5.4966e+00,
            5.2353e+00,  8.0868e+00],
          [ 9.9430e+00,  6.4219e+00,  8.6987e+00,  ...,  6.0790e+00,
            8.8426e+00, -7.1120e-01],
          [ 8.4888e+00,  1.0169e+01,  1.0712e+01,  ...,  1.0351e+01,
            7.3863e-01,  2.0532e+00],
          ...,
```

然后把tensor经过uint8量化、lzma压缩、base64，就可以得到一个url: 

```
http://localhost:8000/image?q=XQAAAAT__________wBoP8SMEkliIGOA_aFNt-ZpGW-SldYWzmNoLTW8cHtw-c1FCQuYZHLgS97cx9PGsKJyztvNBlNZ2YwHG9uYgGZzZw7OMMuWHzyXtteYh-3nT2zqd40cfV0DEOwDDhf04L8MB0sGFi3__lZ5EsirKaR76zGWn_mEgh7a0_kp0iZjSPxLnwIxEUjpPvFc6NSCBCJCSHSNBsLEUmaR9xKMyjTa7zGEWmX2EpYHeAFR6EmZkrXStH2JOAeeaMDwJ7JRVo3FvZJ7RALdtK2Sqo4WQ1nykF-3uyOnNmOCQGr6PJhBWgpPAj_V_97wB9XMF5w9yn7xaz5K_xmF6zXDQ0wrjVwNyT9rUXtcostpQaJpMP-BxtIrsTDe5jrpX2P51rAGbNqecpGvAxl61FmdTtDbCPD-Y0EYsTKIzOCqkmgvfpba4L5g7fx7XVT9C_Drs2MLShXpGPuRkYKOT_PYR7N57wXDkUelJC2ZRF2jE5pqjGXbZ3VsHyeqviFdS5pun4wWu3Eywl0e0gDx8rcXbbQvHBmWe5iqFxjLAb3w-4GKEx0aCOLZ1ldl9xlL6HvBWadG4QjjPtz5TmYyDWiskxSUcomB0RKdXDgHKgNrJk_Tn3iUgfu5GRu5TDnAH4lyCWKivW-AwiTcI1Kip5DrsyO3lxuyRKT4vQGolCgMz4wDm5kNLoH2NtgAUhhlIIsYNLISfauBHW_LIvwThpoBPbY74tq-hc7fe7h4JVYOm9kglf15zL8VmCzV1qUtkSgIcp52N9HMDDVF6Z1Rp6-WGM3bcLxn-mPPO2ibBbd1-XR-KfS8pySkafRe87fNJARyMHNFN47yIh61aRDFX7VN6ecOp9eSYzaGArXtC6e1Agr4prneHd88WZnCeiwvCjXw1qSV-OpCHBXY0PSjIwSY2U0bzlLD056J1sApYeqRo7v_HKR7YRaSkRybF3FMvqs1t908KOMC0dfQvu3dBZLIZNugL_X4TZ3OeV5j958rFR7pINlMUGZ09_5dYbPL5eEhV5pi9OdufZNF0XgnpwBCAXOcqc6pZq0oTUvntnRGV1CFfTOgBYi6_hIbnOMlYDf7Kef1_EJdGR_CztxpNJHPY4oQeAwOjGDQRYXBPq4NbtSa2T8JiEE1dzB-i9eRU09dUjcGx4dsutQOGViRF6EwT4QK6GnliKMsp9X6y1Tnto8VB5DsX91WfLIbK-M5V3BoVv3JfRVglMqIjb-UBZUWIvrDo_xPg25zzUAebkYz0NYfU3JDt5T8ISX14iTFEueCVqk7Q7IFwTR61-r5px8CiT4NYDCzvzk54q2IlDkRbBCSAEcnl3tBkZStq_FKIT76yraMdvRXqF2sjHDeJ99qCymUsZWJY3nGGmlDtTzHJE-Xw4UvwQjXaxOzvMI0icJ-W52CM4RGzhC9xVrpS0f7D0m5dEjUCR5bQwDiuuZU1MD4Ld_5nL_uX25br047B33ygVx2a6o6i2yQC_Azm-j4rDpBjCI_30X3Smq43zTnH9hHtG-sYkrSzfngzW7zuCTfMCslsPzecqDZH1Gv8FaranHvcLNgavfWNDIxNgKlMGYFE1pmWmhOXDAdzSCNFTYRJjcxgN4XNVmG2NBH8FsoGdF8JzDBjTF1u_2z70TP7FMrRY3jLC37us4tT2ckXvzdxCddwnn36LP2BS0SofZ9UkiOUQg90vFasRZwG-RF2u2jZBhuUGm6uJ123koAo_kJTWK0CUMAiCemJ2rbXGcdFPbAE8k_yTwgLlaVl4zUgOvI7bvawsh8LGRZ1ECLS8rtKYXHmdYBX8fnhdZaoxrSMx_r_fXiYdnoEOnyjm_chY683Sbr9SoQ8Fl3asVxN0W6cuPB8-lM7s2Pi_scHGD-u77wly7bfGEBdm6_1O45jW3KHE0sIuJj0hdFGp7euIXQ6icLURG9xEuHyaEZXpYQo33mltTNb0i-VER1Y7vbJYFMpVB3T4rCs7HUlo32TXK-ubAcipY7qNpg43y0WV8OYkqUD7Uqewjn0WlqtH-GY64r8rmuvL86lQEwvqYlpfDSLKxKwuNzqylsr6V4W-mtbj0wM9SGiSWtuj0vkHsWX0Cr1mvPhNFnQRRbc_yGXEG8-cL-dEFaOy8kBKPGfMUDxRxfB8t4BuEbnJ2dOt0Yt8cJiTeBRfbU8PkhuVoscZRa94D0oWi3ahsG5GK9osV0N8TQ6YqERUk7AL0UiOu30IxBQlQeJbUxBH7IMdZCdT8-htT8_uWFzxAv-kfwbKHqrzfJTz15KPvGzdVI-22vOASjgLMlJylftRvtx7k5_AQujVK6QTZYUbuS71nWRpqRAeO2FrMB9F09xqskod5dg2S0uhPecJWH51xrHWr4m2vpxVolN90of4YmEA6rlRRYUmU4iExehYahr8CeCgSM4bl_UQ1bq2Z1Bpa_IoJLYSVCgWKN8P-LGfEpwG2YX8hxR6fKqHFwTrNPm6eFIKjkDGccAgkLAYl4m-BkpQxff2goMJDcFbI1GajIcS94a6e9-J4KommONrQRtye5e71XSBscvaxXn1IfO5WinpYMszX1A4oZOrdtMr8OFRRNDWkht16BL3bWAvjFSmxnx6yfC0a3-4cXcUZvaqqbjaeRr3BjiavjoSiHQrqvb5a9j0WTJfk30RmvCEzw9kb1DBAYYp9xUxNlxMv0eJ_EBo0TErQIjClVita0JygAD9d3GycI98Djda9B7uorwYTDTOwOxjbOL0AbXM3dEfO2ncU039Zo8WNKp5qILQ_fWTA0Fyia2Zgdth_1RQNZgok4FfHRJybLUio23_TAy4FUFU9uARPcimBas3VDZS8QdKE2zmZicHS0U6VLTga8EKNj-TNCi0ofuur8-TC8bGHHxpd6c7DnSWS3l7wdlPBAS0hOw7senuZbCc-A2ghbQiA7nx5ma4Y1xWX9kRTuGe7Cjz6KKdJmtnXj4syTe-ziSFj5TtbymSLT0qaTc0AhGr71_enSHGzQd2qLRc5ZP5JA6TGe4MLtt40qZ5tHnCB4p-McXmfEs6bVFXVBAz5K7RgB8iLnI9abay2SdD15GFffCpzumH4iORMzXtu75uOqifaRGAuKKlMUvMt8aagw2n7i8AjdiFlldB4GXKLvYdF7KKMVtbL0nXF36QCk60PINDYN_ENI0YVExjtirNjQ7koSjh_fU93fC_NirNBKgH3MhJtJOSeDgx24ukdDR3hFvXIvPONjxZflkPLhyoqQvw9gfEwXNBNoxpaAhVHO-fKfz6D7TzkwKZWCqzPuTGqbmeKtnHu2m4bWTiweAgEVuEP_uYMioYeLiOx8QJN61ks2uJB73Qw8v48fth3jlINAhqjEHFiFSik_El5xvLuZB4GQ-Q_D8JQJ3hmYS5oO_gEYavyqMyNURKGGXSGi0jLVg7Aa4GvBeTCz-4JMIIlDFKBjVFsZ6dHJANlciCZd2biCZJ6C9AOpu2R7i-iUt6tCglIcnjvmavwFcBx9WfbeR719-9XmQqAsDhO4eivcD6GhVG-GMP6TJLlD8-kKqRsxK7s6zkneKwyBHHolcXTrmhbWjuMAvhwXlLTFqdTXncwPkNGX-KgocbWeufcdmoddltJ9Nl5ThFFVuptuOmtwyDYESPpc2XB5qp6rLbfzVW5zWEIG8H9sINoHP050XJ7klC462e9a5EuQMUOORSm_C_oD6uHa_xAQ9VFgZZgBICWkiZ_ux6-mqoQNq3AEU7N769LThkgm7vaiLyxF7cgQLw-sXMF4F_CcKhZmj6C2mS8Azzrk4zpO9YeMs4ZUrS0ZrQ8cDmymlz4YvjuJnrVHxU4Xrok-nqqKDwwdNZqK72ijL-1OWqp1NPrsuMvUGWPQTzgVNw4Iw8a_DYM-KCdB2ct52kUza9U9S71e80wGp9AtIOxum6m6cggDlDalFLJSKhanljubPxdk0q5mBDdlEEXYF2R_fld4O4sIOQsb6gjNQ1jPFDnOXsq1bclZM3r85bbWVqTG3fl1IuAYadVfAtFkOZkqyT1O-8ELFAavc5CXFj3tdUdwIe8Ts_3dI6Q53u4QDT-tg6DAE-hDUEv98XOwCDrjw8plzPL2Nmrjryv5ctRJSvquCpa3fnp-3WegsS53bfSCnxJa5P29tNdZxlGmV9SCCZpOezpmP_iass-q96VqnT7EJmM7X5fFUBixCkDqcGBHJsnSvRZ-qQ8HhGNVaZWQ94-7W_ADVe0B6XbPMM1wRHwq8LB1xip3ZHcWy8BmugmCaisFaYOOZX_B8XaB9OinHvajeVgiiQtSacRU3RyabcHfC3dEWoLLG-RSZpwV4LxuuvRyTlKZYD3_yArmqX0bVHrd9Mm0ZTj6RWYOKZMw3SRTm30wh4c879r1Sx9ZxFagra2Yta5Hk5KGEpcMAsu_X6DBRCllR679tL_s0s_ut5I2sT026tbox-vSRsL6aQs8ExOMEF2LVviIxU0eE8aymOZGtIYL-Dk_BfW5j_nKQI7lHbiLdWOSy9f-W2yRBfBZl7vWhyQZdWqCr08Y7BJf8qcD5IA6_L0IK4N0SGY1B_suynIpS-5sIbIg7x9iPCrTo5Ao0QttY0LcdiFeRS1U3Fkq_lANV3ZOaL_MIog5kGCmPrKacA2kobXoza4yNUteiPzD9AhsNWmiJ0kiKahptaMtKqWCRPTvKv9Oe6S_tvYjHk1V3Hremg6WgkNV2LvwOnlyQYoHfJVEncJFkz1fra44JtPGRGd-f2UjZrVWltFVl-8Svx2KM4s-wofXi21pYai9Wh8CWG5gleKu5VQwvrteKM_SphvbNp07i7z5EZK3jT5ieQKyWFxvoZ3ERop9GS0mfHfqJ8EVuhhHL66GtMvZ-_TXtmuFrMEEK8iTJdbC6_ekIwGnUg3BhdIZpi6-7LGSfvt1kM4Awa-ZT4D7OwlD1c4PXmYjT08sLzxLmvS3OvI9UKKCyKXn_4bds7MSe1WXw6pG6YGmsprUYe2LjhUX_dgNuY7zP_2rkbdH9wR8QJ5_BYqcmuDB-_I5qttOGIAUmeYe2eMA2W-wjhF3XVIkhZtUdJvCpLUdFPq1V9u3LnMifMdDKifqRLogtENhMYBir_7cusbj-s6Y2wxkKEroJKAP8dKUcJW8bhkrXL-vZyWAJMwf6n1E-LYpbNuxK-JLY42VCjKR2PW-OFQGunsp4mv7jvmsok-ag_mYMtmPDITQM7Cb9CRH1kWmyZ5O3HaYS3Cgh5FA2MeozhVWmo5uSPqm0x8jVIpyrGj1MuxB1DJsmDfFU1WBRXlCKOC_c7PvF9GjuAu4Fnq6hnpC73tifGZwbEfw7SlOke_pdLfGOr4RsWoSS27gEK65BkD7_yrSxPw-LwEsDFe0yGGLIYxbdzRN--bjkuT2rp5tUdCFXZj56aF5ha9MzVm4xx4_cEhV06aPz2764HzaJp-V1FK4Fn9sBN6tPKa8VIvnsxOFuN8Slwrh7TlEd1pXZwpb6g271t-86bPRETaNbpNgeuxfd8pM24HqJ6dbI-JCNnPw2hMV0puzPq8mERT-c_AdG388mMiqpTjfdpXf5w9TRNXjjWCzSdT7PKT45755uV83hZa023MhrMXOvNfBwy78FswftkAjqL-tlAJ1rnC9SHg2fXmfAWcDZOLoMTqHsOXfrk32v_SrYwbLQO7RVudWYVqQHLD8m3V7lNL2EKUZjkCfO8t0trMBEil4qPYHBWDdTG0XT1Esb6wOSiHFbHZHCYLfMTpDN_QOPhFZ8Ir0mL5GiWjh055RhbF2Xv8PW69jLKyj_pRqmkvWLR4eAw1RkNQe2sDXISyaU4tB9mQMeFhwOUavXmTtARDYJkt6N3vy-jD72XQNthKJHE9QTzweRYPBoUxE-4cu6QcGvZh4ieO4LUI9CbUa6Ec58PlRtT2ZDmLKdjE_fulT5onzcRfTpwtvhihsbPFmdjwzlTd5Ou74JEElSVfmw83foQkWBlGkg-26pLPNsGms-mD1UJoprSrZ8xX5bKn0Hes0TgU9QZ0xrIppDMj4_QQe_m2CtgUFNrXnk-0oXaxnGrJuTVXbTnuugODYYitJKc6sztfBiAUUvIsGtqZMF3Sr2WiluWyXyxDUF7PbLfd9qFm30ETJlq330NBLK8RfOJ2Cb0E3HCWdKVbKn2ADbsvG6sYLeCQYzC_4xDyCDnKaG-HvI0F88oB95S_AllWAYAxxyhs34r5Cy5kWDtj2ov1czJtcI8q18cmmp1xE6mxrkbUpt8ZdRlumKS6OxBknlezQ5-ixfRgyLZF6XA-hzmuYfFg3oVrZ2rDtLs7SWA57Z3RNxK9k1Z_NjDfZIqRFhgiyZZccD_TP2-R0BedCHYtpDWyXuBZPKisUbHj5JKzH8rLegRLe6SS5PztovXzxadoqZj4uUElgozc86mFKksA717BZEbNmbbBZoTqRsNFNOY7n7AkgY6YdrPRzQleioMQ6f3Xh1A34RgfdE9OSU6i7428vmlOvqmyodAKlW-N4uKyr4sWbMeXLqnZG0aZTLzEWkFrOEGa6xAW8XxXzgm9Qdo4EMQRwU2CiFpN78RCIs7wQfux3f1gSJmnPhctJqDCZoWoG82Z4vdu3vNzsoW1ZIJARGqN5191z1mkSCgWypfKuyPNxl-VJzmvzCWyGgpMVleOQN1OSdHTbB3K-U8PZwJVg3RT8UWXVrWCYrmp2xloRw5goNv9FeMElHE_liwpXlaIZV-jtNJcvwoX9Wm9Y1Ugx2jYrit7aHhyKFJtYuqm1GNrn25ntXBIAqDKFPGpXnu0pfqcgdBGlSV9B4bm1knPhoznbV1eg9Icb9zzRpPyxQQzBhVJPiGEJ1K0ZVf9yVJ7E7UaTZcyaP_
```

访问url时，就对上面的操作分别做一次逆操作，然后再送入vae解码，就能还原出这张图片: 

![Lenna_out.webp](example/Lenna_out.webp)

看起来有一点微小的差别，不过大部分是一样的啦！


## 使用方法

首先你需要一个Python3，安装依赖:

```sh
pip install -r requirements.txt
```

启动服务: 

```sh
uvicorn main:app --host 0.0.0.0 --reload
```

然后就可以去`http://localhost:8000/`上传图片啦！


## 注意

emmmbedding看起来很像embedding，但它其实不是，它是恶魔妹妹床上用品！


## 结束

就这样，大家88，我要回去和`emmm`亲热了！
